import{s as $,e as C,c as S,p as y,q as d,i as R,n as k,f as v}from"../chunks/scheduler.Bpan6Ont.js";import{S as w,i as x,c as P,a as L,m as E,t as _,b as A,d as T}from"../chunks/index.B_gktW-4.js";import"../chunks/authority_names.BkSoJQMf.js";import"../chunks/SelectWithCustom.svelte_svelte_type_style_lang.CyHf7iyB.js";import"../chunks/paths.Dwr1h3pI.js";import"../chunks/entry.C7OvZAHp.js";import{F as N}from"../chunks/FileManager.BrVgkXNE.js";import{E as F}from"../chunks/exceljs.min.Cw7gH1Z1.js";import{e as I,f as b,c as D,s as K}from"../chunks/data.izGX6Vfv.js";function W(s){let r=s.getWorksheet("DALog"),t=r.getRow(1).values.map(a=>typeof a=="string"?a:a.result),n=r.getRow(2).values.map(a=>typeof a=="string"?a:a.result??null);t.shift(),t.shift(),n.shift(),n.shift();let i=t.map((a,l)=>[a,n[l]]);return Object.fromEntries(i)}function u(s){return(s+1).toString().padStart(2,"0")}function J(s){let r=I(),t=o=>{let e=s[o];if(typeof e=="string")return e;if(e==null)return"";throw new Error(`${o} isn't a string, it's ${e}`)},n=o=>{let e=s[o];return typeof e=="number"?e:(e==null||console.warn(`${o} isn't a number, it's ${e}. Defaulting to 0`),0)},i=o=>{let e=s[o];if(e==""||e=="Yes"||e=="No")return e;if(e==null)return"";throw new Error(`${o} isn't yesNoBlank, it's ${e}`)},a=o=>{let e=s[o];if(e==""||e=="C"||e=="N/A")return e;if(e==0||e==1||e==2)return e.toString();if(e==null)return"0";throw new Error(`${o} isn't score, it's ${e}`)},l=o=>{let e=t(o).split(", ").map(parseFloat);return[e[1],e[0]]},p=t("Sub-tool")=="Street Check"?"street":"path";r.summary={dateDesignReview:"",schemeReference:t("Scheme Ref"),schemeName:t("Scheme Name"),schemeSummary:"",schemeInfoReviewed:"",authority:t("Authority"),transportOrCombinedAuthority:t("Transport/ Combined Authority"),region:t("Region"),fundingProgramme:t("Funding Programme"),designStage:t("Design Stage"),fundingConditions:t("Funding Conditions"),inspectorEmail:t("Inspector"),assessedRouteLengthKm:n("RouteLength"),totalRouteLengthKm:n("RouteFileLength"),notes:t("Notes"),checkType:p,networkMap:{type:"FeatureCollection",features:[]}},r.horseRiders=s["PA-LOS-HR-E"]=="N/A"?"No":"Yes";for(let[o,e]of r.policyCheck.entries())e.existing=i(`PC${u(o)}-E`),e.proposed=i(`PC${u(o)}-D`);for(let[o,e,g]of[[r.safetyCheck,"SA",0],[r.streetCheck,"ST",16],[r.streetPlacemakingCheck,"SP",0],[r.pathCheck,"PA",16],[r.pathPlacemakingCheck,"PP",0]])for(let c=0;c<o.existingScores.length;c++)o.existingScores[c]=a(`${e}${u(c+g)}-E`),o.proposedScores[c]=a(`${e}${u(c+g)}-D`);for(let o=0;o<35;o++){let e=`${u(o)}PC`;s[`${e}Ref`]!=null&&r.policyConflictLog.push({conflict:t(`${e}Typ`).substr(0,1),stage:t(`${e}Sta`),point:l(`${e}LaL`),locationName:t(`${e}Loc`),resolved:i(`${e}Res`),notes:t(`${e}Com`)})}for(let o=0;o<35;o++){let e=`${u(o)}SA`;s[`${e}Ref`]!=null&&r.criticalIssues.push({criticalIssue:t(`${e}Typ`).split(" - ")[0],stage:t(`${e}Sta`),point:l(`${e}LaL`),locationName:t(`${e}Loc`),resolved:i(`${e}Res`),notes:t(`${e}Com`)})}return r}function q(s){let r=W(s),t=J(r),n=[],i=s.getWorksheet("1. Summary of Scheme");t.summary.schemeSummary=m(i.getCell("C9")),t.summary.schemeInfoReviewed=m(i.getCell("C10")),i=s.getWorksheet("2.1 Policy Check");for(let a=0;a<6;a++)t.policyCheck[a].commentary=m(i.getCell("F"+(8+a)));return h(t.safetyCheck,s,"3.1 Safety Check",["J","K","L","M"],f([[13,28]]),n),h(t.streetCheck,s,"4.1 Street Check",["J","K","L","M"],f([[13,19],[23,25],[29,34],[38,43],[47,50]]),n),h(t.streetPlacemakingCheck,s,"4.2 Street Placemaking Check",["I","J","K","L"],f([[13,15],[19,21],[25,34],[38,47]]),n),h(t.pathCheck,s,"5.1 Path Check",["J","K","L","M"],f([[15,19],[23,33],[37,40],[44,48],[52,56]]),n),h(t.pathPlacemakingCheck,s,"5.2 Path Placemaking Check",["I","J","K","L"],f([[12,14],[20,22],[26,29],[33,41]]),n),i=s.getWorksheet("7.1 Results Summary"),t.resultsReviewStatement=m(i.getCell("G7")),t.resultsReviewStatement=="Use the space to provide overall feedback for the proposed scheme."&&(t.resultsReviewStatement=""),[t,n]}function m(s){if(typeof s.value=="string")return s.value;if(s.value==null)return"";throw new Error(`Input cell isn't a string, it's ${s.value}`)}function f(s){let r=[];for(let[t,n]of s)for(let i=t;i<=n;i++)r.push(i);return r}function h(s,r,t,n,i,a){let l=r.getWorksheet(t);if(i.length!=s.existingScores.length)throw new Error(`Wrong Excel ranges for ${t}`);let p=0;try{for(let o=0;o<s.existingScores.length;o++){p=o;let e=i[o];s.existingScoreNotes[o]=m(l.getCell(n[1]+e)),s.proposedScoreNotes[o]=m(l.getCell(n[3]+e))}}catch(o){a.push(`Error while importing the comments from sheet ${t}, row ${p}: ${o}`)}}function M(s){let r,t=`The Route Check Tool is used by ATE for assessing the design quality of
    linear schemes. However, it may also be used by local authorities and others
    wishing to assess the design quality of schemes against ATE's quality
    criteria.`;return{c(){r=C("p"),r.textContent=t,this.h()},l(n){r=S(n,"P",{slot:!0,"data-svelte-h":!0}),y(r)!=="svelte-5d82im"&&(r.textContent=t),this.h()},h(){d(r,"slot","description")},m(n,i){R(n,r,i)},p:k,d(n){n&&v(r)}}}function O(s){let r,t;return r=new N({props:{files:b,currentFile:D,state:K,xlsxImporter:s[0],service:"Route Check Tool",fileObjectType:"scheme",$$slots:{description:[M]},$$scope:{ctx:s}}}),{c(){P(r.$$.fragment)},l(n){L(r.$$.fragment,n)},m(n,i){E(r,n,i),t=!0},p(n,[i]){const a={};i&2&&(a.$$scope={dirty:i,ctx:n}),r.$set(a)},i(n){t||(_(r.$$.fragment,n),t=!0)},o(n){A(r.$$.fragment,n),t=!1},d(n){T(r,n)}}}function j(s){async function r(t){let n=new F.Workbook;return await n.xlsx.load(t),q(n)}return[r]}class X extends w{constructor(r){super(),x(this,r,j,O,$,{})}}export{X as component};
